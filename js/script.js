const MENU_DATA = [
  {
    "categoria": "Cafetería",
    "productos": [
      {
        "nombre": "Café Espresso",
        "descripcion": "",
        "precio": 2500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Café Jarrita",
        "descripcion": "",
        "precio": 2500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Café Doble",
        "descripcion": "",
        "precio": 3800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Café con Leche",
        "descripcion": "",
        "precio": 2800,
        "img": "/images/productos/caf_con_leche_1759338139087.JPEG"
      },
      {
        "nombre": "Café Cortado",
        "descripcion": "",
        "precio": 2800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Café Lágrima",
        "descripcion": "",
        "precio": 2900,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Café con Crema",
        "descripcion": "",
        "precio": 5700,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Café Irlandés",
        "descripcion": "",
        "precio": 6900,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Café Affogato",
        "descripcion": "",
        "precio": 5500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Iced coffee",
        "descripcion": "",
        "precio": 3800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Iced latte",
        "descripcion": "",
        "precio": 4500,
        "img": "/images/productos/icedlatte.png"
      },
      {
        "nombre": "Café bombón",
        "descripcion": "",
        "precio": 6200,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Capuccino",
        "descripcion": "",
        "precio": 5200,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Café Freddo",
        "descripcion": "",
        "precio": 5800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Chocolatada (fría o caliente)",
        "descripcion": "",
        "precio": 3600,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Chocolate Submarino",
        "descripcion": "",
        "precio": 4700,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Té negro",
        "descripcion": "",
        "precio": 3200,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Té con leche",
        "descripcion": "",
        "precio": 3800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Té especiales",
        "descripcion": "",
        "precio": 4300,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Mate cocido",
        "descripcion": "",
        "precio": 2700,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Mate cocido con leche",
        "descripcion": "",
        "precio": 3200,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Yogurt con granola, frutas y miel",
        "descripcion": "",
        "precio": 6300,
        "img": "/images/productos/default.svg"
      }
    ]
  },
  {
    "categoria": "Desayuno Ejecutivo",
    "productos": [
      {
        "nombre": "Combo 1",
        "descripcion": "Café o té + 2 Medialunas",
        "precio": 6500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo 2",
        "descripcion": "Café o té + 1 Waffle con miel o salsa",
        "precio": 6500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo 3",
        "descripcion": "Café o té + Pastafrola o tarta de coco con dulce de leche",
        "precio": 7000,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo 4",
        "descripcion": "Café o té + 2 Tostadas con 2 dips",
        "precio": 6500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo 5",
        "descripcion": "Café o té + 100gr de chipá",
        "precio": 4800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo 6",
        "descripcion": "Café o té + 1 Medialuna de jamón y queso",
        "precio": 6500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo 7",
        "descripcion": "Café o té + 1 Tostada con 1 feta de jamón y queso",
        "precio": 6500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo 8",
        "descripcion": "Café o té + 1 Tostada con rúcula y jamón crudo",
        "precio": 6500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo 9",
        "descripcion": "Café o té + Huevo revuelto con o sin semillas",
        "precio": 5400,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo 10",
        "descripcion": "Yogurt con granola, frutas y miel (sin infusión)",
        "precio": 5400,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo 11",
        "descripcion": "Café o té + 150gr bizcochos",
        "precio": 4800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Cambio de infusión por jugo de naranja mediano",
        "descripcion": "",
        "precio": 1100,
        "img": "/images/productos/default.svg"
      }
    ]
  },
  {
    "categoria": "Especialidades",
    "productos": [
      {
        "nombre": "Sandwich Génova",
        "descripcion": "Pan de Molde, Queso Crema, Jamón, Queso y Omelet de Huevo",
        "precio": 7600,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Opción Keto",
        "descripcion": "",
        "precio": 9000,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Brusqueta Sicilia",
        "descripcion": "Pan de Campo, Queso Crema con Cebollita de Verdeo, Rúcula, Tomates Confitados y Cerdo Ahumado",
        "precio": 6500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Opción Keto",
        "descripcion": "",
        "precio": 7200,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Brusqueta Turín",
        "descripcion": "Pan de Campo, Queso Crema, Palta, Tomates Confitados y Huevo",
        "precio": 7600,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Opción Keto",
        "descripcion": "",
        "precio": 8300,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Brusqueta Capri",
        "descripcion": "Pan de Campo, Queso Crema, Frutas de Estación, Miel y Granola",
        "precio": 6000,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Opción Keto",
        "descripcion": "",
        "precio": 6700,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Brusqueta Siena",
        "descripcion": "Pan de campo, Crema de nuestro Cheesecake con Reducción de Frutos Rojos",
        "precio": 5700,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Opción Keto",
        "descripcion": "",
        "precio": 6400,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Pancakes Roma",
        "descripcion": "2 Pancakes Tibios con Frutas de Estación, Miel o Salsa y Coco",
        "precio": 6700,
        "img": "/images/productos/default.svg"
      }
    ]
  },
  {
    "categoria": "Bebidas",
    "productos": [
      {
        "nombre": "Jugo de naranja mediano",
        "descripcion": "360ml",
        "precio": 3600,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Jarra de limonada",
        "descripcion": "2 litros (Opcional: Menta y Jengibre)",
        "precio": 11500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Jugo de naranja grande",
        "descripcion": "500ml",
        "precio": 4300,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Limonada mediana",
        "descripcion": "360ml",
        "precio": 3300,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Limonada grande",
        "descripcion": "500ml",
        "precio": 3800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Licuado con agua",
        "descripcion": "500ml (Sabores: Frutilla, Durazno o Banana)",
        "precio": 4300,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Licuado con leche",
        "descripcion": "500ml (Sabores: Frutilla, Durazno o Banana)",
        "precio": 4900,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Milkshake",
        "descripcion": "500ml (Sabores: Vainilla, Dulce de Leche o Frutilla. Con salsa de chocolate o caramelo y crema chantilly)",
        "precio": 5400,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Smoothies",
        "descripcion": "360ml (Sabores Varios)",
        "precio": 5400,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Agua 600 ml",
        "descripcion": "",
        "precio": 1800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Agua con gas 500 ml",
        "descripcion": "",
        "precio": 2000,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Agua saborizada 500 ml",
        "descripcion": "",
        "precio": 2400,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Agua tónica 375 ml",
        "descripcion": "",
        "precio": 2700,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Gaseosa 500 ml",
        "descripcion": "",
        "precio": 2700,
        "img": "/images/productos/default.svg"
      }
    ]
  },
  {
    "categoria": "Combos",
    "productos": [
      {
        "nombre": "Combo Clásico",
        "descripcion": "Café + 2 Medialunas o 150gr bizcochos +  jugo de naranja",
        "precio": 7000,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo Chipá",
        "descripcion": "Café + 100g de chipá + jugo de naranja",
        "precio": 6900,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo Proteico",
        "descripcion": "Café + tostón de J&Q y huevo revuelto + jugo de naranja mediano",
        "precio": 13000,
        "img": "/images/productos/combo_proteico_1759337968932.JPEG"
      },
      {
        "nombre": "Combo Fit",
        "descripcion": "Café + yogurt con granola y frutas + jugo de naranja",
        "precio": 10800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo Italia",
        "descripcion": "Café + porción de torta/tarta + jugo de naranja",
        "precio": 12400,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo Mbejú",
        "descripcion": "Café + Mbejú relleno de J&Q",
        "precio": 11300,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Combo Para dos",
        "descripcion": "Café + 2 medialunas + 2 tostadas con dips + porción de pastafrola o tarta de coco con dulce de leche + 100g de chipá + jugo de naranja",
        "precio": 23700,
        "img": "/images/productos/default.svg"
      }
    ]
  },
  {
    "categoria": "Dulces",
    "productos": [
      {
        "nombre": "Medialuna Dulce",
        "descripcion": "",
        "precio": 1600,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Porción de Pepas",
        "descripcion": "Porción de 5 unidades.",
        "precio": 3500,
        "img": "/images/productos/porci_n_de_pepas_1759338017636.JPEG"
      },
      {
        "nombre": "Tostadas pan de molde con 2 dips",
        "descripcion": "Mermelada de frutilla/naranja, dulce de leche y queso crema",
        "precio": 6000,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Alfajores de la casa",
        "descripcion": "(2 unidades)",
        "precio": 3300,
        "img": "/images/productos/alfajores_de_la_casa_1759337949426.JPEG"
      },
      {
        "nombre": "Porción de Cheesecake",
        "descripcion": "",
        "precio": 7500,
        "img": "/images/productos/cheesecake.png"
      },
      {
        "nombre": "Porción de Pastafrola",
        "descripcion": "",
        "precio": 7500,
        "img": "/images/productos/porci_n_de_pastafrola_1759337916810.JPEG"
      },
      {
        "nombre": "Porción de Alfajores de Maicena",
        "descripcion": "",
        "precio": 7500,
        "img": "/images/productos/porci_n_de_alfajores_de_maicena_1759337932431.JPEG"
      },
      {
        "nombre": "Porción de Lemon Pie",
        "descripcion": "",
        "precio": 7500,
        "img": "/images/productos/porci_n_de_lemon_pie_1759338049884.JPEG"
      },
      {
        "nombre": "Porción de no se que de frutos rojos",
        "descripcion": "",
        "precio": 7500,
        "img": "/images/productos/porci_n_de_no_se_que_de_frutos_rojos_1759338036959.JPEG"
      },
      {
        "nombre": "Porción de Chocotorta",
        "descripcion": "",
        "precio": 7500,
        "img": "/images/productos/porci_n_de_chocotorta_1759338083767.JPEG"
      },
      {
        "nombre": "Porción de Tiramisú",
        "descripcion": "",
        "precio": 7500,
        "img": "/images/productos/porci_n_de_tiramis_1759338099812.JPEG"
      },
      {
        "nombre": "Porción de el coso de dulce de leche",
        "descripcion": "",
        "precio": 7500,
        "img": "/images/productos/porci_n_de_el_coso_de_dulce_de_leche_1759338158027.JPEG"
      },
      {
        "nombre": "Porción de Tarta de Coco",
        "descripcion": "",
        "precio": 7500,
        "img": "/images/productos/porci_n_de_tarta_de_coco_1759337876968.JPEG"
      },
      {
        "nombre": "Tortas Enteras",
        "descripcion": "",
        "precio": 45000,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Tartas Enteras",
        "descripcion": "",
        "precio": 45000,
        "img": "/images/productos/tortas_enteras_1759335487429.JPEG"
      },
      {
        "nombre": "Bowl frutas de estación, coco y miel",
        "descripcion": "",
        "precio": 6500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Waffles con miel o salsa",
        "descripcion": "(2 Unidades)",
        "precio": 4300,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Waffles con frutas o 2 bochas de helado",
        "descripcion": "(2 Unidades)",
        "precio": 6700,
        "img": "/images/productos/default.svg"
      }
    ]
  },
  {
    "categoria": "Salados",
    "productos": [
      {
        "nombre": "Chipá (100gr)",
        "descripcion": "",
        "precio": 3000,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Bizcochos de grasa (100gr)",
        "descripcion": "",
        "precio": 1800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Bizcochos de grasa (250gr)",
        "descripcion": "",
        "precio": 3800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Sandwich J&Q + Queso Crema en pan de campo",
        "descripcion": "",
        "precio": 6800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Tostón con huevos revueltos J&Q",
        "descripcion": "1 Tostada +  2 Huevos revueltos +  Rollitos de J&Q",
        "precio": 7000,
        "img": "/images/productos/tost_n_con_huevos_revueltos_j_q_1759338003337.JPEG"
      },
      {
        "nombre": "Medialuna Salada",
        "descripcion": "",
        "precio": 1600,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Medialuna con J&Q",
        "descripcion": "Opcional: Medialuna salada/dulce",
        "precio": 4800,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Sandwich jamón crudo y rúcula",
        "descripcion": "",
        "precio": 10000,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Tostón de huevo revuelto con J&Q integrado",
        "descripcion": "",
        "precio": 6600,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Mbejú relleno de J&Q",
        "descripcion": "",
        "precio": 8600,
        "img": "/images/productos/mbej_relleno_de_j_q_1759335335454.JPEG"
      }
    ]
  },
  {
    "categoria": "Adicionales",
    "productos": [
      {
        "nombre": "Huevo",
        "descripcion": "",
        "precio": 860,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Queso",
        "descripcion": "",
        "precio": 1100,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Jamón",
        "descripcion": "",
        "precio": 1100,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Jamón crudo",
        "descripcion": "",
        "precio": 1700,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Dip",
        "descripcion": "",
        "precio": 1400,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Crema chantilly",
        "descripcion": "",
        "precio": 1200,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Jugo de naranja en combo",
        "descripcion": "",
        "precio": 2200,
        "img": "/images/productos/jugo_de_naranja_en_combo_1759338067307.JPEG"
      },
      {
        "nombre": "Vaso de soda mediano",
        "descripcion": "360ml",
        "precio": 1100,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Helado / Frutas",
        "descripcion": "",
        "precio": 1600,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Miel / Salsa",
        "descripcion": "",
        "precio": 650,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Pan Keto (unidad)",
        "descripcion": "",
        "precio": 1700,
        "img": "/images/productos/default.svg"
      }
    ]
  },
  {
    "categoria": "Mbejú",
    "productos": [
      {
        "nombre": "Mbejú de Jamón y Queso",
        "descripcion": "",
        "precio": 9000,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Mbejú de Rúcula y Jamón Crudo",
        "descripcion": "",
        "precio": 10500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Mbejú de Rúcula, Palta, Huevo Revuelto y Tomates Confitados",
        "descripcion": "",
        "precio": 10500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Mbejú de Rúcula, Cerdo Ahumado y Tomates Confitados",
        "descripcion": "",
        "precio": 10500,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Mbejú de Palta y Huevo Revuelto",
        "descripcion": "",
        "precio": 9000,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Mbejú de Jamón, Rúcula y Tomates Confitados",
        "descripcion": "",
        "precio": 9000,
        "img": "/images/productos/default.svg"
      },
      {
        "nombre": "Mbejú Italia",
        "descripcion": "Masa de Mbejú + 3 Ingredientes a Elección",
        "precio": 10500,
        "img": "/images/productos/default.svg"
      }
    ]
  }
];

function formatPrice(num) {
  if (num === null || num === undefined) return "";
  return new Intl.NumberFormat("es-AR", {
    style: "currency",
    currency: "ARS",
    minimumFractionDigits: 0,
  }).format(num);
}

function createElement(type, options = {}) {
  const el = document.createElement(type);
  if (options.className) el.className = options.className;
  if (options.text) el.textContent = options.text;
  if (options.html) el.innerHTML = options.html;
  if (options.attrs) {
    Object.entries(options.attrs).forEach(([k, v]) => el.setAttribute(k, v));
  }
  return el;
}

const STORE_SCHEDULE = {
  // DO: Cerrado
  0: null,
  // LU-VI: 07:00-12:30 y 17:00-21:00
  1: [{ open: "07:00", close: "12:30" }, { open: "17:00", close: "21:00" }],
  2: [{ open: "07:00", close: "12:30" }, { open: "17:00", close: "21:00" }],
  3: [{ open: "07:00", close: "12:30" }, { open: "17:00", close: "21:00" }],
  4: [{ open: "07:00", close: "12:30" }, { open: "17:00", close: "21:00" }],
  5: [{ open: "07:00", close: "12:30" }, { open: "17:00", close: "21:00" }],
  // SA: 09:00-12:30 y 17:00-21:00
  6: [{ open: "09:00", close: "12:30" }, { open: "17:00", close: "21:00" }],
};

function isStoreOpen() {
  const now = new Date(new Date().toLocaleString("en-US", { timeZone: "America/Argentina/Buenos_Aires" }));
  const dayOfWeek = now.getDay();
  const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
  const todaysSchedule = STORE_SCHEDULE[dayOfWeek];
  if (!todaysSchedule) return false;
  return todaysSchedule.some(slot => currentTime >= slot.open && currentTime < slot.close);
}

function renderAllProducts() {
  const container = document.getElementById("menu-container");
  container.innerHTML = "";

  MENU_DATA.forEach((catData) => {
    if (catData.categoria.includes("Nuestra Cocina") && catData.productos.length === 0) {
      const note = createElement("section", { className: "menu-section" });
      const title = createElement("h2", {
        html: `<u><strong>${catData.categoria}</strong></u>`,
      });
      note.appendChild(title);
      container.appendChild(note);
      return;
    }

    if (catData.productos.length === 0) return;

    const section = createProductSection(catData);
    container.appendChild(section);
  });
}

function createProductSection(catData) {
  const sectionId = catData.categoria.replace(/\s+/g, "-").toLowerCase();
  const section = createElement("section", {
    className: "menu-section",
    attrs: { id: sectionId, "data-category": catData.categoria },
  });
  const h2 = createElement("h2", { text: catData.categoria });
  section.appendChild(h2);

  catData.productos.forEach((product) => {
    const item = createProductItem(product);
    section.appendChild(item);
  });

  return section;
}

function createAddToCartButton(product) {
  const button = createElement("button", {
    className: "add-to-cart-btn",
    html: '<i class="fas fa-plus"></i> Añadir',
  });
  button.addEventListener("click", (e) => {
    e.stopPropagation();
    if (!isStoreOpen()) {
      const originalHTML = button.innerHTML;
      button.innerHTML = '<i class="fas fa-times"></i> Cerrado';
      button.classList.add("disabled-temp");
      setTimeout(() => {
        button.classList.remove("disabled-temp");
        button.innerHTML = originalHTML;
      }, 2000);
      return;
    }

    e.stopPropagation();
    addToCart(product);
    button.innerHTML = '<i class="fas fa-check"></i> Añadido';
  });
  return button;
}

function createProductItem({ nombre, descripcion, precio, img }) {
  const item = createElement("article", { className: "menu-item" });

  const info = createElement("div", { className: "product-info" });
  const nameEl = createElement("h3", { className: "product-name", text: nombre });
  info.appendChild(nameEl);
  if (descripcion && descripcion.trim() !== "") {
    const descEl = createElement("p", { className: "product-desc", text: descripcion });
    info.appendChild(descEl);
  }
  if (precio !== null && precio !== undefined) {
    const priceEl = createElement("div", { className: "product-price", text: formatPrice(precio) });
    info.appendChild(priceEl);
  }
  if (precio !== null && precio !== undefined) {
    const addButton = createAddToCartButton({ nombre, precio, descripcion });
    info.appendChild(addButton);
  }

  item.appendChild(info);

  const imgContainer = createElement("div", {
    className: "product-img-container",
    attrs: { tabindex: "0", role: "button", "aria-label": `Ver imagen del producto ${nombre}` },
  });

  if (img === "/images/productos/default.svg") {
    imgContainer.classList.add("nozoom");
  }

  const imgEl = createElement("img", {
    className: "product-img",
    attrs: {
      src: img,
      alt:
        img === "/images/productos/default.svg"
          ? "default"
          : `Foto del producto ${nombre} con bordes redondeados`,
      loading: "lazy",
      draggable: "false",
    },
  });
  imgContainer.appendChild(imgEl);
  item.appendChild(imgContainer);

  if (img !== "/images/productos/default.svg") {
    imgContainer.addEventListener("click", () => openLightbox(img, nombre));
    imgContainer.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        openLightbox(img, nombre);
      }
    });
  }

  return item;
}

function normalizeText(text) {
  if (!text) return "";
  return text
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}

function filterProducts() {
  const searchTerm = normalizeText(document.getElementById("search-input").value);
  const sections = document.querySelectorAll(".menu-section");

  sections.forEach((section) => {
    const items = section.querySelectorAll(".menu-item");
    let sectionHasVisibleItems = false;

    items.forEach((item) => {
      const name = normalizeText(item.querySelector(".product-name").textContent);
      const desc = normalizeText(item.querySelector(".product-desc")?.textContent);
      const isVisible = name.includes(searchTerm) || desc.includes(searchTerm);
      item.style.display = isVisible ? "" : "none";
      if (isVisible) sectionHasVisibleItems = true;
    });

    section.style.display = sectionHasVisibleItems ? "" : "none";
  });
}

let lastScrollY = window.scrollY;

function handleScroll() {
  const stickyControls = document.getElementById("sticky-controls");
  const categoryBar = stickyControls.querySelector(".category-bar");
  const currentScrollY = window.scrollY;

  if (window.innerWidth <= 768) {
    if (currentScrollY > lastScrollY && currentScrollY > stickyControls.offsetTop + 50) {
      categoryBar.classList.add("hidden-on-scroll");
    } else {
      categoryBar.classList.remove("hidden-on-scroll");
    }
  }
  lastScrollY = currentScrollY <= 0 ? 0 : currentScrollY;
}

function createScrollspy() {
  const sections = document.querySelectorAll(".menu-section");
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const categoryName = entry.target.dataset.category;
          updateActiveCategory(categoryName);
        }
      });
    },
    { rootMargin: "-40% 0px -60% 0px" }
  );

  sections.forEach((section) => {
    if (section.dataset.category) {
      observer.observe(section);
    }
  });
}

function updateActiveCategory(categoryName) {
  categoryButtons.forEach((btn) => {
    const btnCategoryName = btn.dataset.categoryName;
    if (btnCategoryName === categoryName) {
      btn.classList.add("category-active");
      btn.setAttribute("aria-pressed", "true");
      btn.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
    } else {
      btn.classList.remove("category-active");
      btn.setAttribute("aria-pressed", "false");
    }
  });
}

const lightbox = document.getElementById("lightbox");
const lightboxImg = document.getElementById("lightbox-img");
const lightboxClose = document.getElementById("lightbox-close");

function openLightbox(src, nombre) {
  lightboxImg.src = src;
  lightboxImg.alt = `Imagen ampliada del producto ${nombre} con bordes redondeados`;
  lightbox.classList.add("is-visible");
  document.body.style.overflow = "hidden";
  lightboxClose.focus();
}

function closeLightbox() {
  lightbox.classList.remove("is-visible");
  lightboxImg.src = "";
  document.body.style.overflow = "";
  document.activeElement.blur();
}

function getCart() {
  return JSON.parse(localStorage.getItem("italiaCafeCart")) || [];
}

function saveCart(cart) {
  localStorage.setItem("italiaCafeCart", JSON.stringify(cart));
  updateCartUI();
}

function addToCart(product) {
  const cart = getCart();
  cart.push(product);
  saveCart(cart);
}

function updateCartUI() {
  const cart = getCart();
  const cartBar = document.getElementById("cart-bar");
  const cartItemCountText = document.getElementById("cart-item-count-text");

  if (!cartBar || !cartItemCountText) return;

  if (cart.length > 0) {
    cartItemCountText.textContent = `Ver Carrito (${cart.length})`;
    cartBar.classList.remove("hidden");
  } else {
    cartBar.classList.add("hidden");
  }
}

lightboxClose.addEventListener("click", closeLightbox);
lightbox.addEventListener("click", (e) => {
  if (e.target === lightbox) closeLightbox();
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && lightbox.classList.contains("is-visible")) {
    closeLightbox();
  }
});

const categoryButtons = document.querySelectorAll(".category-bar .category");
categoryButtons.forEach((btn) => {
  btn.addEventListener("click", () => {
    const categoryName = btn.dataset.categoryName;
    if (!categoryName) return;

    const sectionId = categoryName.replace(/\s+/g, "-").toLowerCase();
    const sectionElement = document.getElementById(sectionId);
    if (sectionElement) {
      window.removeEventListener("scroll", handleScroll, { passive: true });
      lenis.scrollTo(sectionElement, { offset: -150 });
      updateActiveCategory(categoryName);
      setTimeout(() => window.addEventListener("scroll", handleScroll, { passive: true }), 1000);
    }
  });
});

let lenis;

document.addEventListener("DOMContentLoaded", () => {
  renderAllProducts();
  updateCartUI();
  createScrollspy();

  if (!isStoreOpen()) {
    const closedMessage = document.getElementById("closed-store-message");
    if(closedMessage) closedMessage.classList.remove("hidden");
  }

  document.getElementById("search-input").addEventListener("input", filterProducts);
  window.addEventListener("scroll", handleScroll, { passive: true });

  lenis = new Lenis({
    duration: 1.2,
    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
  });

  function raf(time) {
    lenis.raf(time);
    requestAnimationFrame(raf);
  }
  requestAnimationFrame(raf);

  const moreInfoToggle = document.getElementById("more-info-toggle");
  const moreInfoPanel = document.getElementById("more-info-panel");
  const mobileOverlay = document.getElementById("mobile-info-overlay");
  const closeMoreInfoBtn = document.getElementById("close-more-info");

  function openMobileInfo() {
    moreInfoToggle.setAttribute("aria-expanded", "true");
    moreInfoPanel.classList.add("is-open");
    mobileOverlay.classList.add("is-active");
    document.body.style.overflow = "hidden";
  }

  function closeMobileInfo() {
    moreInfoToggle.setAttribute("aria-expanded", "false");
    moreInfoPanel.classList.remove("is-open");
    mobileOverlay.classList.remove("is-active");
    document.body.style.overflow = "";
  }

  if (moreInfoToggle && moreInfoPanel && mobileOverlay && closeMoreInfoBtn) {
    moreInfoToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      const isExpanded = moreInfoPanel.classList.contains("is-open");
      isExpanded ? closeMobileInfo() : openMobileInfo();
    });
    mobileOverlay.addEventListener("click", closeMobileInfo);
    closeMoreInfoBtn.addEventListener("click", closeMobileInfo);
  }

  const mobileHoursToggle = document.getElementById("mobile-hours-toggle");
  const mobileHoursPanel = document.getElementById("mobile-hours-panel");
  const closeMobileHoursBtn = document.getElementById("close-mobile-hours");

  function openMobileHours() {
    mobileHoursPanel.classList.add("is-open");
    mobileHoursToggle.setAttribute("aria-expanded", "true");
  }

  function closeMobileHours() {
    mobileHoursPanel.classList.remove("is-open");
    mobileHoursToggle.setAttribute("aria-expanded", "false");
  }

  if (mobileHoursToggle && mobileHoursPanel && closeMobileHoursBtn) {
    mobileHoursToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      openMobileHours();
    });
    closeMobileHoursBtn.addEventListener("click", closeMobileHours);
    mobileOverlay.addEventListener("click", closeMobileHours);
  }

  const desktopHoursToggle = document.getElementById("desktop-hours-toggle");
  const desktopHoursPanel = document.getElementById("desktop-hours-panel");
  const closeDesktopHoursBtn = document.getElementById("close-desktop-hours");

  if (desktopHoursToggle && desktopHoursPanel && closeDesktopHoursBtn) {
    desktopHoursToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      const isOpen = desktopHoursPanel.classList.toggle("is-open");
      desktopHoursToggle.setAttribute("aria-expanded", isOpen);
    });
    closeDesktopHoursBtn.addEventListener("click", () => {
      desktopHoursPanel.classList.remove("is-open");
      desktopHoursToggle.setAttribute("aria-expanded", "false");
    });
    document.addEventListener("click", (e) => {
      if (desktopHoursPanel.classList.contains("is-open") && !desktopHoursPanel.contains(e.target) && !desktopHoursToggle.contains(e.target)) {
        desktopHoursPanel.classList.remove("is-open");
        desktopHoursToggle.setAttribute("aria-expanded", "false");
      }
    });
  }

  function checkOpenStatus() {
    const isOpen = isStoreOpen();
    const statusIndicator = document.getElementById("open-status-indicator");
    const mobileStatusIndicator = document.getElementById("mobile-open-status-indicator");
    const setStatus = (indicator, isOpen) => {
      if (!indicator) return;
      indicator.textContent = isOpen ? "Abierto" : "Cerrado";
      indicator.className = `open-status ${isOpen ? "is-open" : "is-closed"}`;
    };
    setStatus(statusIndicator, isOpen);
    setStatus(mobileStatusIndicator, isOpen);
  }
  checkOpenStatus();
  setInterval(checkOpenStatus, 60000);

  const scrollUpBtn = document.getElementById("scroll-up");
  function toggleScrollUpButton() {
    scrollUpBtn.classList.toggle("show-scroll", window.scrollY >= 350);
  }
  window.addEventListener("scroll", toggleScrollUpButton);
  scrollUpBtn.addEventListener("click", (e) => {
    e.preventDefault();
    lenis.scrollTo(0);
  });
});
